name: PR Validation

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Check PR Description
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';

            // æ£€æŸ¥PRæè¿°æ˜¯å¦åŒ…å«åŸºæœ¬ä¿¡æ¯
            const requiredSections = [
              'å˜æ›´æè¿°',
              'æµ‹è¯•',
              'æ£€æŸ¥æ¸…å•'
            ];

            const missingSections = requiredSections.filter(section => 
              !body.includes(section)
            );

            if (missingSections.length > 0) {
              core.setFailed(`PRæè¿°ç¼ºå°‘ä»¥ä¸‹å¿…è¦éƒ¨åˆ†: ${missingSections.join(', ')}`);
            }

            // æ£€æŸ¥æ˜¯å¦å¡«å†™äº†å˜æ›´ç±»å‹
            const hasChangeType = /- \[x\]/.test(body);
            if (!hasChangeType) {
              core.warning('è¯·åœ¨PRæè¿°ä¸­é€‰æ‹©è‡³å°‘ä¸€ç§å˜æ›´ç±»å‹');
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰ç›¸å…³çš„issueé“¾æ¥ï¼ˆå¯é€‰ï¼‰
            const hasIssueLink = /Closes #\d+|Related to #\d+/.test(body);
            if (!hasIssueLink) {
              core.info('å»ºè®®åœ¨PRä¸­å…³è”ç›¸å…³çš„issue');
            }

            console.log('PRæè¿°éªŒè¯å®Œæˆ');

      - name: Check for Breaking Changes
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            const title = pr.title || '';

            // æ£€æŸ¥æ˜¯å¦æœ‰ç ´åæ€§å˜æ›´
            const hasBreakingChange = 
              title.includes('BREAKING') || 
              body.includes('ç ´åæ€§å˜æ›´') ||
              body.includes('breaking change');

            if (hasBreakingChange) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  labels: ['breaking-change']
                });
                
                core.warning('âš ï¸ æ­¤PRåŒ…å«ç ´åæ€§å˜æ›´ï¼Œè¯·ç¡®ä¿ï¼š\n1. åœ¨æè¿°ä¸­è¯¦ç»†è¯´æ˜å˜æ›´å†…å®¹\n2. æ›´æ–°ç›¸å…³æ–‡æ¡£\n3. è€ƒè™‘ç‰ˆæœ¬å·å˜æ›´');
              } catch (error) {
                core.warning(`æ— æ³•æ·»åŠ æ ‡ç­¾ï¼š${error.message}`);
              }
            }

      - name: Welcome First Time Contributors
        uses: actions/first-interaction@v1
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          pr-message: |
            ğŸ‰ æ„Ÿè°¢æ‚¨çš„ç¬¬ä¸€æ¬¡è´¡çŒ®ï¼

            æ¬¢è¿åŠ å…¥Laminaç¤¾åŒºï¼æˆ‘ä»¬å¾ˆé«˜å…´çœ‹åˆ°æ‚¨çš„è´¡çŒ®ã€‚

            åœ¨æ‚¨çš„PRè¢«reviewæœŸé—´ï¼Œè¯·ç¡®ä¿ï¼š
            - âœ… ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒ
            - âœ… åŒ…å«å¿…è¦çš„æµ‹è¯•
            - âœ… æ›´æ–°äº†ç›¸å…³æ–‡æ¡£

            å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜ï¼Œå¯ä»¥ï¼š
            - ğŸ’¬ åŠ å…¥æˆ‘ä»¬çš„QQç¾¤ï¼šhttps://qm.qq.com/q/QwPXCgsJea
            - ğŸ“– æŸ¥çœ‹è´¡çŒ®æŒ‡å—ï¼šhttps://github.com/lamina-dev/Lamina/blob/main/documents/CONTRIBUTING-CN.md

            å†æ¬¡æ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼ğŸš€

      - name: Validate PR Title
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title || '';

            // æ£€æŸ¥æ ‡é¢˜æ ¼å¼
            const titlePattern = /^(feat|fix|docs|style|refactor|test|chore|perf|ci|build)(\(.+\))?: .+/;

            if (!titlePattern.test(title)) {
              core.warning(`âš ï¸ PRæ ‡é¢˜å»ºè®®ä½¿ç”¨çº¦å®šå¼æäº¤æ ¼å¼ï¼š
              - feat: æ–°åŠŸèƒ½
              - fix: ä¿®å¤ bug
              - docs: æ–‡æ¡£å˜æ›´
              - style: ä»£ç æ ¼å¼å˜æ›´
              - refactor: ä»£ç é‡æ„
              - test: æµ‹è¯•ç›¸å…³
              - chore: å…¶ä»–æ‚é¡¹
              - perf: æ€§èƒ½ä¼˜åŒ–
              - ci: CI/CDç›¸å…³
              - build: æ„å»ºç›¸å…³
              
              ç¤ºä¾‹: "feat(interpreter): æ·»åŠ æ–°çš„æ•°æ®ç±»å‹æ”¯æŒ"`);
            }

            // æ£€æŸ¥æ ‡é¢˜é•¿åº¦
            if (title.length > 72) {
              core.warning('âš ï¸ PRæ ‡é¢˜è¿‡é•¿ï¼Œå»ºè®®æ§åˆ¶åœ¨72ä¸ªå­—ç¬¦ä»¥å†…');
            }

            if (title.length < 10) {
              core.warning('âš ï¸ PRæ ‡é¢˜è¿‡çŸ­ï¼Œè¯·æä¾›æ›´è¯¦ç»†çš„æè¿°');
            }

      - name: Check File Changes
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // è·å–å˜æ›´çš„æ–‡ä»¶
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            const changedFiles = files.map(file => file.filename);

            // æ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº†æ ¸å¿ƒæ–‡ä»¶
            const coreFiles = changedFiles.filter(file => 
              file.startsWith('interpreter/') && (file.endsWith('.cpp') || file.endsWith('.hpp'))
            );

            if (coreFiles.length > 0) {
              core.info(`ğŸ”§ æ£€æµ‹åˆ°æ ¸å¿ƒè§£é‡Šå™¨æ–‡ä»¶å˜æ›´: ${coreFiles.join(', ')}`);
            }

            // æ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº†æ„å»ºæ–‡ä»¶
            const buildFiles = changedFiles.filter(file => 
              file.includes('CMakeLists.txt') || file.startsWith('.github/workflows/')
            );

            if (buildFiles.length > 0) {
              core.info(`ğŸ—ï¸ æ£€æµ‹åˆ°æ„å»ºç³»ç»Ÿæ–‡ä»¶å˜æ›´: ${buildFiles.join(', ')}`);
            }

            // æ£€æŸ¥å¤§å‹æ–‡ä»¶å˜æ›´
            const largeFiles = files.filter(file => file.additions + file.deletions > 500);

            if (largeFiles.length > 0) {
              core.warning(`âš ï¸ æ£€æµ‹åˆ°å¤§å‹æ–‡ä»¶å˜æ›´ (>500è¡Œ): ${largeFiles.map(f => f.filename).join(', ')}`);
            }

            console.log(`ğŸ“Š å˜æ›´ç»Ÿè®¡: ${files.length} ä¸ªæ–‡ä»¶ï¼Œ+${files.reduce((sum, f) => sum + f.additions, 0)} -${files.reduce((sum, f) => sum + f.deletions, 0)} è¡Œ`);

      - name: Security Check
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            const title = pr.title || '';

            // æ£€æŸ¥æ˜¯å¦åŒ…å«æ•æ„Ÿä¿¡æ¯
            const sensitivePatterns = [
              /password/i,
              /secret/i,
              /token/i,
              /api[_-]?key/i,
              /private[_-]?key/i
            ];

            const foundSensitive = sensitivePatterns.some(pattern => 
              pattern.test(title) || pattern.test(body)
            );

            if (foundSensitive) {
              core.warning('âš ï¸ PRæè¿°ä¸­å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œè¯·æ£€æŸ¥å¹¶ç¡®ä¿æ²¡æœ‰æ³„éœ²å¯†é’¥æˆ–å¯†ç ');
            }

            // æ£€æŸ¥æ˜¯å¦æ·»åŠ äº†æ–°çš„ä¾èµ–
            if (body.includes('dependency') || body.includes('ä¾èµ–')) {
              core.info('â„¹ï¸ æ£€æµ‹åˆ°å¯èƒ½çš„ä¾èµ–å˜æ›´ï¼Œè¯·ç¡®ä¿æ–°ä¾èµ–æ˜¯å¿…è¦çš„ä¸”å®‰å…¨çš„');
            }
