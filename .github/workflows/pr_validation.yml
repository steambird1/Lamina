name: PR Validation

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check PR Description
      uses: actions/github-script@v6
      with:
        script: |
          const pr = context.payload.pull_request;
          const body = pr.body || '';
          
          // æ£€æŸ¥PRæè¿°æ˜¯å¦åŒ…å«åŸºæœ¬ä¿¡æ¯
          const requiredSections = [
            'å˜æ›´æè¿°',
            'æµ‹è¯•',
            'æ£€æŸ¥æ¸…å•'
          ];
          
          const missingSections = requiredSections.filter(section => 
            !body.includes(section)
          );
          
          if (missingSections.length > 0) {
            core.setFailed(`PRæè¿°ç¼ºå°‘ä»¥ä¸‹å¿…è¦éƒ¨åˆ†: ${missingSections.join(', ')}`);
          }
          
          // æ£€æŸ¥æ˜¯å¦å¡«å†™äº†å˜æ›´ç±»å‹
          const hasChangeType = /- \[x\]/.test(body);
          if (!hasChangeType) {
            core.warning('è¯·åœ¨PRæè¿°ä¸­é€‰æ‹©è‡³å°‘ä¸€ç§å˜æ›´ç±»å‹');
          }
          
          // æ£€æŸ¥æ˜¯å¦æœ‰ç›¸å…³çš„issueé“¾æ¥ï¼ˆå¯é€‰ï¼‰
          const hasIssueLink = /Closes #\d+|Related to #\d+/.test(body);
          if (!hasIssueLink) {
            core.info('å»ºè®®åœ¨PRä¸­å…³è”ç›¸å…³çš„issue');
          }
          
          console.log('PRæè¿°éªŒè¯å®Œæˆ');

    - name: Check for Breaking Changes
      uses: actions/github-script@v6
      with:
        script: |
          const pr = context.payload.pull_request;
          const body = pr.body || '';
          const title = pr.title || '';
          
          // æ£€æŸ¥æ˜¯å¦æœ‰ç ´åæ€§å˜æ›´
          const hasBreakingChange = 
            title.includes('BREAKING') || 
            body.includes('ç ´åæ€§å˜æ›´') ||
            body.includes('breaking change');
          
          if (hasBreakingChange) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['breaking-change']
            });
            
            core.warning('âš ï¸ æ­¤PRåŒ…å«ç ´åæ€§å˜æ›´ï¼Œè¯·ç¡®ä¿ï¼š\n1. åœ¨æè¿°ä¸­è¯¦ç»†è¯´æ˜å˜æ›´å†…å®¹\n2. æ›´æ–°ç›¸å…³æ–‡æ¡£\n3. è€ƒè™‘ç‰ˆæœ¬å·å˜æ›´');
          }

    - name: Welcome First Time Contributors
      uses: actions/first-interaction@v1
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        pr-message: |
          ğŸ‰ æ„Ÿè°¢æ‚¨çš„ç¬¬ä¸€æ¬¡è´¡çŒ®ï¼
          
          æ¬¢è¿åŠ å…¥Laminaç¤¾åŒºï¼æˆ‘ä»¬å¾ˆé«˜å…´çœ‹åˆ°æ‚¨çš„è´¡çŒ®ã€‚
          
          åœ¨æ‚¨çš„PRè¢«reviewæœŸé—´ï¼Œè¯·ç¡®ä¿ï¼š
          - âœ… ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒ
          - âœ… åŒ…å«å¿…è¦çš„æµ‹è¯•
          - âœ… æ›´æ–°äº†ç›¸å…³æ–‡æ¡£
          
          å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜ï¼Œå¯ä»¥ï¼š
          - ğŸ’¬ åŠ å…¥æˆ‘ä»¬çš„QQç¾¤ï¼šhttps://qm.qq.com/q/QwPXCgsJea
          - ğŸ“– æŸ¥çœ‹è´¡çŒ®æŒ‡å—ï¼šhttps://github.com/lamina-dev/Lamina/blob/main/documents/CONTRIBUTING-CN.md
          
          å†æ¬¡æ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼ğŸš€
